#!/bin/bash

if [ -z "$EXTERNALS" ]; then
    echo 'Please set the $EXTERNALS environmental variable before running this script.'
    echo 'If you are using this script as a first time import of externals make youreself a directory and set the $EXTERNALS variable.'
    exit 1
fi

# An offsite maintainer might have a different local username than the FNAL kerberos principal
# Can change this variable to allow kerberized scp
script_user=`whoami`
novavmhost='novagpvm04.fnal.gov'
fnalvm="$script_user@$novavmhost"

cd ${EXTERNALS}
mkdir tars
cd tars

# get the pull script
wget http://scisoft.fnal.gov/scisoft/bundles/tools/pullProducts
chmod +x pullProducts

./pullProducts ${EXTERNALS} slf5 nu-v1_07_01 s6-e6 debug
./pullProducts ${EXTERNALS} slf5 nu-v1_07_01 s6-e6 prof
./pullProducts ${EXTERNALS} slf6 nu-v1_07_01 s6-e6 debug
./pullProducts ${EXTERNALS} slf6 nu-v1_07_01 s6-e6 prof


# pull novadaq tars
remote_location=http://scisoft.fnal.gov/scisoft/packages/novadaq/v03_00_06
for os in slf5 slf6
do
  for build in debug prof
  do
    cd ${EXTERNALS}/tars
    tarball=novadaq-03.00.06-${os}-x86_64-e6-${build}.tar.bz2
    if [ ! -e $tarball ];then
      wget ${remote_location}/${tarball}
      cd ${EXTERNALS}
      tar xf tars/${tarball}
    fi
  done 
done


# pull novaddt tars 
remote_location=http://scisoft.fnal.gov/scisoft/packages/novaddt/v03_00_08
for os in slf5 slf6
do
  for build in debug prof
  do
    cd ${EXTERNALS}/tars
    tarball=novaddt-03.00.08-${os}-x86_64-e6-${build}.tar.bz2
    if [ ! -e $tarball ];then
      wget ${remote_location}/${tarball}
      cd ${EXTERNALS}
      tar xf tars/${tarball}
    fi
  done
done


# pull Valgrind
for os in slf5 slf6
do
  remote_location=http://scisoft.fnal.gov/scisoft/packages/valgrind/v3_10_1
  tarball=valgrind-3.10.1-${os}-x86_64.tar.bz2
  cd ${EXTERNALS}/tars
  if [ ! -e $tarball ];then
    wget ${remote_location}/${tarball}
    cd ${EXTERNALS}/tars
    tar xf tars/${tarball}
  fi
done

#pull nutools v1_07_03

for os in slf5 slf6;
do 
  for build in debug prof
  do 
    cd ${EXTERNALS}/tars
    remote_location=http://scisoft.fnal.gov/scisoft/packages/nutools/v1_07_03
    tarball=nutools-1.07.03-${os}-x86_64-e6-${build}.tar.bz2
    if [ ! -e $tarball ];then
      wget ${remote_location}/${tarball}
    fi
    cd ${EXTERNALS}
     tar -xf ${EXTERNALS}/tars/${tarball}
  done
done



#pull ifdh_art v1_7_1 - standard build in case of any dependencies
for os in slf5 slf6; 
do 
  for build in debug prof
  do
      cd ${EXTERNALS}/tars
     ./pullProducts ${EXTERNALS} $os ifdh-v1_7_1 s6-e6 $build; 
  done
done

#pull ifdh_art v1_7_1 - nu build
for os in slf5 slf6
do 
  for build in debug prof 
  do 
    cd ${EXTERNALS}/tars
    remote_location=http://scisoft.fnal.gov/scisoft/packages/ifdh_art/v1_7_1
    tarball=ifdh_art-1.7.1-${os}-x86_64-e6-nu-s6-${build}.tar.bz2; 
    if [ ! -e $tarball ];then
      wget ${remote_location}/${tarball}
    fi
    cd ${EXTERNALS}
    tar -xf ${EXTERNALS}/tars/${tarball}
  done
done


cd $EXTERNALS

# First time install should first download upd product
# Used to be part of the ups install, probably an oversight in the newest version.
if [ ! -d "upd" ]; then
  cd ${EXTERNALS}/tars
  remote_location=http://scisoft.fnal.gov/scisoft/packages/upd/v5_0_1
  tarball=upd-5.0.1-noarch.tar.bz2
  if [ ! -e $tarball ];then
    wget ${remote_location}/${tarball}
    cd ${EXTERNALS}
    tar xf tars/${tarball}
  fi

  cd ${EXTERNALS}/tars
  remote_location=http://scisoft.fnal.gov/scisoft/packages/upd/v5_0_1
  tarball=upd-5.0.1-source.tar.bz2
  if [ ! -e $tarball ];then
    wget ${remote_location}/${tarball}
    cd ${EXTERNALS}
    tar xf tars/${tarball}
  fi

  cd $EXTERNALS

  tar xf tars/upd-5.0.1-source.tar.bz2
fi

source $EXTERNALS/setup
setup upd

upd install lid		                v01.00
upd install eid		                v01.00
upd install hmatrix	                v01.00
upd install lemlittle	                v01.02
upd install qepid	                v01.00
upd install remid	                v01.00
upd install ucana	                v01.02
upd install rvp                         v01.00
upd install calibcsvs                   v01.01
upd install sam_web_client              v1_8
upd install jobsub_tools                v1_3_1_1_3
upd install condb                       v2_0b
upd install jobsub_client               v1_0_4
upd install -G "-c" NovaGridUtils       v01.23

#jobsub_client seems to use a non-standard way to require pycurl, hence the upd install does not pull
#pycurl in as dependency
#manually install them
upd install -G "-c" pycurl v7_15_5 -H Linux64bit+2.6-2.5
upd install -G "-c" pycurl v7_16_4 -H Linux64bit+2.6-2.12
