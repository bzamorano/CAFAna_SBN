#!/bin/bash

if [ $# -ne 1 ] 
then
        echo "Usage: make_nova_build_prof_log input_log"
        exit 1
fi

loginp=$1
ls $loginp &> /dev/null
if [ $? -ne 0 ] 
then
        echo "Input file $loginp not found"
        exit 1
fi

# Set log directory and names
webdir=/nusoft/app/web/htdoc/nova/novasoft/logs/proflogs
day=`date +%a`
logfile=nova_${day}_fnal_profbuild.html
logoutp="$webdir/$logfile"
tmpname="nova_prof_tmp.html"

# Make a temporary copy that's more html friendly
# Convert < and > and replace end of line flag.
sed 's/--->>/\*\*\*\*/g' $loginp > $tmpname
sed -i 's/</\&lt\;/g' $tmpname
sed -i 's/>/\&gt\;/g' $tmpname
sed -i 's/$/<br>/g' $tmpname

# build the final log file, including highlighting errors and conflicts
echo "<html>" > $logoutp
echo "<body>" >> $logoutp
echo '<pre style="color:red">' >> $logoutp
echo "---------------------------------------------">>$logoutp
echo "Any Build Errors and CVS Conflicts follow.">>$logoutp
echo "(See the body of the logfile for context.)<strong>">>$logoutp
grep -i 'error:' $tmpname >> $logoutp
errorcount=`grep -c error: $tmpname`
grep -i conflict $tmpname >> $logoutp
confcount=`grep -c conflict $tmpname`
echo "<big>Done with $errorcount errors and $confcount conflicts</big></strong>">>$logoutp
echo "---------------------------------------------">>$logoutp
echo "</pre>" >> $logoutp

echo '<pre style="color:orange">' >> $logoutp
echo "---------------------------------------------">>$logoutp
echo "Any Build Warnings follow.">>$logoutp
echo "(See the body of the logfile for context.)<strong>">>$logoutp
grep -i warning $tmpname >> $logoutp
warncount=`grep -c warning $tmpname`
echo "<big>Done with $warncount warnings </big></strong>">>$logoutp
echo "---------------------------------------------">>$logoutp
echo "</pre>" >> $logoutp

cat $tmpname >> $logoutp
echo "</body>" >> $logoutp
echo "</html>" >> $logoutp

rm -f $tmpname

# make a link to the latest log file
target=$webdir/latest_profbuild.html
rm -f $target
cp $logoutp $target
