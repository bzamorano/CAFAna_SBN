#!/bin/bash

if [ $# -ne 2 ] 
then
        echo "Usage: make_nova_branch_build_log input_log output_dir"
        exit 1
fi

loginp=$1
ls $loginp &> /dev/null
if [ $? -ne 0 ] 
then
        echo "Input file $loginp not found"
        exit 1
fi

logdir=$2
ls $loginp &> /dev/null
if [ $? -ne 0 ] 
then
        echo "Output directory $logdir not found"
        exit 1
fi

# Set log directory and names
day=`date +%a`
logfile=nova_build_$day.html
logoutp="$logdir/$logfile"
tmpname="$logdir/nova_tmp.html"

# Make a temporary copy that's more html friendly
# Convert < and > and replace end of line flag.
sed 's/--->>/\*\*\*\*/g' $loginp > $tmpname
sed -i 's/</\&lt\;/g' $tmpname
sed -i 's/>/\&gt\;/g' $tmpname
sed -i 's/$/<br>/g' $tmpname
sed -i 's/‘/\&\#8216/g' $tmpname
sed -i 's/’/\&\#8217/g' $tmpname

# build the final log file, including highlighting errors and conflicts
echo "<html>" > $logoutp
echo "<body>" >> $logoutp
echo '<pre style="color:red">' >> $logoutp
echo "---------------------------------------------">>$logoutp
echo "Any Build Errors and CVS Conflicts follow.">>$logoutp
echo "(See the body of the logfile for context.)<strong>">>$logoutp
grep -i 'error:' $tmpname >> $logoutp
errorcount=`grep -c error: $tmpname`
grep -i conflict $tmpname >> $logoutp
confcount=`grep -c conflict $tmpname`
echo "<big>Done with $errorcount errors and $confcount conflicts</big></strong>">>$logoutp
echo "---------------------------------------------">>$logoutp
echo "</pre>" >> $logoutp

echo '<pre style="color:orange">' >> $logoutp
echo "---------------------------------------------">>$logoutp
echo "Any Build Warnings follow.">>$logoutp
echo "(See the body of the logfile for context.)<strong>">>$logoutp
grep -i warning $tmpname >> $logoutp
warncount=`grep -c warning $tmpname`
echo "<big>Done with $warncount warnings </big></strong>">>$logoutp
echo "---------------------------------------------">>$logoutp
echo "</pre>" >> $logoutp

echo '<pre style="color:green">' >> $logoutp
echo "---------------------------------------------">>$logoutp
grep -i "image size" $tmpname >> $logoutp
echo "---------------------------------------------">>$logoutp
echo "</pre>" >> $logoutp

cat $tmpname >> $logoutp
echo "</body>" >> $logoutp
echo "</html>" >> $logoutp

rm -f $tmpname

# make a link to the latest log file
target=$logdir/latest_branch_build.html
rm -f $target
cp $logoutp $target
